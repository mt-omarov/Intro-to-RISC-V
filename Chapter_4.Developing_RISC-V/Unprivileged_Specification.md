# Непривилегированная спецификация
## Организация спецификаций
RISC-V ISA состоит из двух частей:
- Том 1, Непривилегированная спецификация
- Том 2, Привилегированная спецификация
Чтобы понять, почему спецификация разбита на две разные части, мы должны сначала немного разобраться в компьютерной архитектуре и безопасности. 
Исторически процессоры использовали иерархические домены защиты, часто называемые кольцами защиты, для защиты данных и кода от злоумышленников.

![image](https://github.com/mt-omarov/Intro-to-RISC-V/assets/95280619/e45e2b86-2645-4b9a-98d9-89cfc10c3c03)
[Герцшпрунг в английской Википедии, CC BY-SA 3.0](https://commons.wikimedia.org/w/index.php?curid=8950144)

Наиболее привилегированный код работает в "кольце 0" и имеет доступ ко всей системе. 
Процессор решает, какие привилегии предоставить исполняемому коду, основываясь на уровне привилегий. 
Например, доступ к памяти по физическому адресу может быть ограничен "кольцом 0", так что другие кольца должны ссылаться на виртуальное адресное пространство. 
Обычно процессор может одновременно работать только в одном из режимов привилегий, а для перехода между режимами существуют специальные инструкции. 
Все эти детали могут меняться от системы к системе, однако они должны соответствовать правилам, установленным в документах спецификации данной архитектуры.

В настоящее время RISC-V имеет три уровня привилегий: Режим пользователя (U-mode), режим супервизора (S-mode) и машинный режим (M-mode). 
Их можно представить как "кольцо 2", "кольцо 1" и "кольцо 0" соответственно. Другие режимы, такие как режим гипервизора (H-mode), вероятно, 
будут добавлены в ближайшем будущем. Как и на рисунке выше, режим U предназначен для пользовательских процессов, режим S - для ядра и/или драйверов устройств, 
а режим M - для загрузчика и/или микропрограммы. Каждый уровень привилегий имеет доступ к определенным регистрам управления и состояния (CSR), 
и более высокие уровни привилегий могут получить доступ к CSR менее привилегированных уровней.

## Внутри непривилегированной спецификации

Проще говоря, непривилегированная спецификация описывает элементы, не относящиеся к машинному режиму (M-mode) или режиму супервизора (S-mode). 
Непривилегированная спецификация включает базовую ISA, а также расширения этой базы, такие как целочисленные (I), плавающие (F), двойные (D), 
сжатые инструкции (C) и многие другие.

Базовые наборы инструкций описывают формат инструкций, основные целочисленные инструкции, инструкции загрузки и хранения, 
а также другие фундаментальные детали ISA. Мы разбиваем их на несколько баз:
1. RV32I - Целое число 32 бита
2. RV32E - уменьшенный RV32I для встраиваемых систем
3. RV64I - Целое число 64 бита
4. RV128I - Целое число 128 бит

Все эти "базовые ISA" либо уменьшают, либо расширяют базовый набор инструкций RV32I. 
Например, RV64I расширяет целочисленные регистры и поддерживаемое адресное пространство пользователя до 64 бит. Это означает, что инструкции LOAD и STORE работают немного иначе, чем в RV32I, и непривилегированная спецификация содержит главу, объясняющую эти различия.

## Расширения базового ISA
Непривилегированная спецификация также содержит описания расширений этих базовых ISA. Опять же, любое расширение, которое не требует M-режима для работы, может быть описано в непривилегированной спецификации.

Каждое расширение базового ISA разрабатывается и поддерживается целевой группой:

- Crypto Task Group работает над криптографическими расширениями, которые могут перенести многие сложные криптографические алгоритмы в аппаратное обеспечение, повышая надежность и скорость.
- B Extension Task Group работает над расширениями для работы с битами, которые могут ускорить выполнение многих распространенных математических задач.
- Vector (V) Extension Task Group работает над векторными инструкциями, которые лежат в основе многих вычислений при обработке графики.

После ратификации эти расширения добавляются в непривилегированную спецификацию. 
Ниже перечислены некоторые из ратифицированных расширений, которые вы можете увидеть в процессоре RISC-V:

**Расширение стандарта "М"**
Глава 7 [непривилегированной спецификации](https://riscv.org/technical/specifications/) описывает, как должно выполняться умножение и деление целых чисел. 
В ней описывается поведение каждой из инструкций умножения (MUL, MULH, MULHU, MULHU, MULW), какие регистры используются для множителя и множимого, 
и где хранится результат. То же самое делается и для деления, поскольку функционально можно рассматривать деление как просто обратное умножению. 
Вам может показаться странным, что это расширение не требуется. Однако для многих встроенных процессоров умножение можно выполнять программно, 
если оно требуется нечасто или вообще не требуется. Удаление этой логики из процессора позволит сэкономить деньги на разработке и снизить стоимость 
конечного продукта.

**Расширение стандарта "F"**
В главе 11 описано, как мы добавляем вычислительные инструкции с плавающей точкой одинарной точности, соответствующие стандарту арифметики IEEE 754-2008. 
Существует множество ресурсов, описывающих детали арифметики с плавающей точкой в вычислениях. 
Достаточно понять, что эта глава описывает, как этот процесс реализован в RISC-V, и дополняется главой 12 (расширение D), 
которая описывает вычислительные инструкции двойной точности с плавающей точкой. Наконец, в главе 13 рассматривается расширение стандарта Q для 128-битных 
двоичных инструкций с плавающей точкой четверной точности. Все эти три расширения соответствуют стандартам IEEE. Опять же, многие встроенные приложения 
не требуют логики с плавающей точкой, и поэтому это расширение не является частью базовых ISA.

**Расширение стандарта "С"**
В главе 16 описано расширение сжатого набора инструкций, которое уменьшает статический и динамический размер кода путем добавления 
коротких 16-битных кодировок инструкций для общих операций. Как правило, 50%-60% инструкций RISC-V в программе могут быть заменены инструкциями RVC, 
что приводит к уменьшению размера кода на 25%-30%. Расширение C совместимо со всеми другими стандартными расширениями инструкций. 
Расширение C позволяет свободно смешивать 16-битные инструкции с 32-битными, причем последние могут начинаться с любой 16-битной границы. 
Таким образом, при добавлении расширения C в любую систему ни одна инструкция не может вызвать исключения, связанные с выравниванием адресов инструкций.

Это охватывает большинство ратифицированных в настоящее время расширений в непривилегированной спецификации. 
Однако важно отметить, что многие расширения включены в спецификацию на стадии "черновика" или "заморозки". 
Как мы уже говорили в разделе "Жизненный цикл расширений RISC-V", эти спецификации еще не ратифицированы, и любая реализация должна 
избегать их использования в производстве.
